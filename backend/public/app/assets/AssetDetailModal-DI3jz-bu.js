import{n as g,j as e,F as S,a as v}from"./index-DBrcc5-Y.js";import{r as d}from"./handsontable-B9UYrM3w.js";import N from"./SearchableCombo-oPOBtK-b.js";import C from"./ServiceLogTable-Bk5tS3gD.js";import"./react-DJG_os-6.js";const k=[{value:"straight_line",label:"Straight Line"},{value:"declining_balance",label:"Declining Balance"},{value:"units_of_production",label:"Units of Production"}];function D({id:n,onClose:o}){const[c,p]=d.useState("General"),[m,u]=d.useState(!1),[i,x]=d.useState(!1),[b,j]=d.useState(""),[_,f]=d.useState(""),[t,l]=d.useState({description:"",type_code:"",life_months:60,depr_method:"straight_line",residual_rate:0,quantity:1,is_serialized:!1,vat_inclusive:!1,gross_amount:0,include_in_audits:!1,status:"ACTIVE"}),h=!!n;d.useEffect(()=>{(async()=>{if(n){u(!0);try{const a=await g.get(`/app/api/assets/${n}`);l(s=>({...s,...a.data})),j(a.data?.type_code||""),f(a.data?.supplier_name||"")}finally{u(!1)}}})()},[n]);async function y(a=!0){x(!0);try{const s={...t};h||delete s.id,h?await g.patch(`/app/api/assets/${n}`,s,{headers:{"X-XSRF-TOKEN":v.get("XSRF-TOKEN")||""},withCredentials:!0}):await g.post("/app/api/assets",s,{headers:{"X-XSRF-TOKEN":v.get("XSRF-TOKEN")||""},withCredentials:!0}),a&&o(!0)}catch(s){alert(s?.response?.data?.message||"Save failed")}finally{x(!1)}}function r({label:a,children:s,col:w="col-span-4"}){return e.jsxs("div",{className:`${w}`,children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:a}),s]})}return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>o(!1)}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-xl w-full max-w-6xl mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:i,onClick:()=>y(!0),className:"px-4 py-2 bg-green-700 text-white rounded hover:bg-green-600",children:"Save & Close"}),e.jsx("button",{disabled:i,onClick:()=>y(!1),className:"px-4 py-2 border rounded",children:"Save"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500",children:h?"Asset No":"New Asset"}),e.jsx("div",{className:"font-semibold",children:h?t.asset_no||"":"tmp(temporary)"})]}),e.jsx("button",{onClick:()=>o(!1),className:"p-1 rounded hover:bg-gray-100",children:e.jsx(S,{className:"h-6 w-6 text-gray-600"})})]}),e.jsx("div",{className:"px-4 pt-3",children:e.jsx("div",{className:"flex gap-2 border-b",children:["General","Finance","Service","Notes","History","Picture"].map(a=>e.jsx("button",{onClick:()=>p(a),className:`px-3 py-2 border-b-2 -mb-px ${c===a?"border-green-700 text-green-700":"border-transparent text-gray-600 hover:text-gray-800"}`,children:a},a))})}),e.jsxs("div",{className:"p-4",children:[m&&e.jsx("div",{className:"p-6 text-center",children:"Loading…"}),!m&&e.jsxs(e.Fragment,{children:[c==="General"&&e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsx(r,{label:"Description",col:"col-span-8",children:e.jsx("input",{className:"w-full border rounded px-3 py-2",value:t.description,onChange:a=>l(s=>({...s,description:a.target.value})),required:!0})}),e.jsx(r,{label:"Asset Type",col:"col-span-4",children:e.jsx(N,{placeholder:"Search type…",fetchUrl:"/app/api/lookups/asset-types",selectedLabel:b,onChange:a=>{l(s=>({...s,type_code:a?.value||""})),j(a?.label||"")}})}),e.jsx(r,{label:"Life (months)",col:"col-span-2",children:e.jsx("input",{type:"number",min:1,className:"w-full border rounded px-3 py-2",value:t.life_months,onChange:a=>l(s=>({...s,life_months:Number(a.target.value||1)}))})}),e.jsx(r,{label:"Depreciation Method",col:"col-span-3",children:e.jsx("select",{className:"w-full border rounded px-3 py-2",value:t.depr_method,onChange:a=>l(s=>({...s,depr_method:a.target.value})),children:k.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})}),e.jsx(r,{label:"Residual %",col:"col-span-2",children:e.jsx("input",{type:"number",min:0,max:100,step:.01,className:"w-full border rounded px-3 py-2",value:t.residual_rate,onChange:a=>l(s=>({...s,residual_rate:Number(a.target.value||0)}))})}),e.jsx(r,{label:"Quantity",col:"col-span-2",children:e.jsx("input",{type:"number",min:1,step:1,className:"w-full border rounded px-3 py-2",value:t.quantity,onChange:a=>l(s=>({...s,quantity:Number(a.target.value||1)}))})}),e.jsx(r,{label:"Serialized",col:"col-span-3",children:e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!t.is_serialized,onChange:a=>l(s=>({...s,is_serialized:a.target.checked}))})," ",e.jsx("span",{children:"Yes"})]})}),e.jsx(r,{label:"Manufacturer",col:"col-span-4",children:e.jsx("input",{className:"w-full border rounded px-3 py-2",value:t.manufacturer||"",onChange:a=>l(s=>({...s,manufacturer:a.target.value}))})}),e.jsx(r,{label:"Brand",col:"col-span-4",children:e.jsx("input",{className:"w-full border rounded px-3 py-2",value:t.brand||"",onChange:a=>l(s=>({...s,brand:a.target.value}))})}),e.jsx(r,{label:"Model",col:"col-span-4",children:e.jsx("input",{className:"w-full border rounded px-3 py-2",value:t.model||"",onChange:a=>l(s=>({...s,model:a.target.value}))})})]}),c==="Finance"&&e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsx(r,{label:"Supplier",col:"col-span-6",children:e.jsx(N,{placeholder:"Search supplier…",fetchUrl:"/app/api/lookups/vendors",selectedLabel:_,onChange:a=>{l(s=>({...s,supplier_id:a?.id??null,supplier_name:a?.label??null})),f(a?.label??"")}})}),e.jsx(r,{label:"Purchased",col:"col-span-3",children:e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:t.purchase_date||"",onChange:a=>l(s=>({...s,purchase_date:a.target.value||null}))})}),e.jsx(r,{label:"In Service",col:"col-span-3",children:e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:t.in_service_date||"",onChange:a=>l(s=>({...s,in_service_date:a.target.value||null}))})}),e.jsx(r,{label:"Warranty Expires",col:"col-span-3",children:e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:t.warranty_expires||"",onChange:a=>l(s=>({...s,warranty_expires:a.target.value||null}))})}),e.jsx(r,{label:"Reference (CV/PO/Inv)",col:"col-span-5",children:e.jsx("input",{className:"w-full border rounded px-3 py-2",value:t.reference||"",onChange:a=>l(s=>({...s,reference:a.target.value}))})}),e.jsx(r,{label:"VAT Inclusive",col:"col-span-2",children:e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!t.vat_inclusive,onChange:a=>l(s=>({...s,vat_inclusive:a.target.checked}))})," ",e.jsx("span",{children:"Yes"})]})}),e.jsx(r,{label:"VAT %",col:"col-span-2",children:e.jsx("input",{type:"number",min:0,max:100,step:.01,className:"w-full border rounded px-3 py-2",value:t.vat_rate||0,onChange:a=>l(s=>({...s,vat_rate:Number(a.target.value||0)}))})}),e.jsx(r,{label:"Total Gross Amount",col:"col-span-3",children:e.jsx("input",{type:"number",min:0,step:.01,className:"w-full border rounded px-3 py-2",value:t.gross_amount,onChange:a=>l(s=>({...s,gross_amount:Number(a.target.value||0)}))})})]}),c==="Service"&&(h?e.jsx(C,{assetId:n}):e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to manage service logs."})),c==="Notes"&&e.jsx("textarea",{className:"w-full min-h-44 border rounded px-3 py-2",value:t.notes||"",onChange:a=>l(s=>({...s,notes:a.target.value}))}),c==="History"&&(h?e.jsx(T,{table:"asset_details",id:n}):e.jsx("div",{className:"text-sm text-gray-600",children:"History appears after first save."})),c==="Picture"&&(h?e.jsx(F,{id:n,currentUrl:t.picture_path,onUploaded:a=>l(s=>({...s,picture_path:a}))}):e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to upload a picture."}))]})]})]})]})}function T({table:n,id:o}){const[c,p]=d.useState([]),[m,u]=d.useState(!1);return d.useEffect(()=>{(async()=>{u(!0);try{const i=await g.get("/app/api/audit-logs",{params:{table:n,id:o}});p(i.data||[])}finally{u(!1)}})()},[n,o]),m?e.jsx("div",{children:"Loading…"}):c.length?e.jsx("div",{className:"border rounded",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"Timestamp"}),e.jsx("th",{className:"p-2",children:"Action"}),e.jsx("th",{className:"p-2",children:"User"}),e.jsx("th",{className:"p-2",children:"Workstation"}),e.jsx("th",{className:"p-2",children:"Summary"})]})}),e.jsx("tbody",{children:c.map((i,x)=>e.jsxs("tr",{className:x%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:i.changed_at}),e.jsx("td",{className:"p-2",children:i.action}),e.jsx("td",{className:"p-2",children:i.changed_by||""}),e.jsx("td",{className:"p-2",children:i.workstation_id||""}),e.jsx("td",{className:"p-2 truncate",children:i.summary||""})]},x))})]})}):e.jsx("div",{className:"text-sm text-gray-600",children:"No history yet."})}function F({id:n,currentUrl:o,onUploaded:c}){const[p,m]=d.useState(null),[u,i]=d.useState(!1);async function x(){if(p){i(!0);try{const b=new FormData;b.append("file",p);const j=await g.post(`/app/api/assets/${n}/picture`,b,{headers:{"Content-Type":"multipart/form-data"}});c(j.data.picture_path)}finally{i(!1)}}}return e.jsxs("div",{className:"space-y-3",children:[o&&e.jsx("img",{src:o,alt:"Asset",className:"max-h-60 rounded border"}),e.jsx("input",{type:"file",accept:"image/*",onChange:b=>m(b.target.files?.[0]||null)}),e.jsx("button",{disabled:!p||u,onClick:x,className:"px-4 py-2 bg-green-700 text-white rounded disabled:opacity-50",children:"Upload"})]})}export{D as default};
