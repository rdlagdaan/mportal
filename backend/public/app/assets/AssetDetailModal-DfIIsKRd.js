import{n as b,j as e,F as M,a as U}from"./index-Dt7AywvS.js";import{r as c}from"./handsontable-B9UYrM3w.js";import S from"./SearchableCombo-e4binP0S.js";import"./react-DJG_os-6.js";function W({id:d,onClose:u}){const[o,m]=c.useState("General"),[j,g]=c.useState(!1),[p,v]=c.useState(!1),[N,_]=c.useState(""),[P,T]=c.useState(""),[B,E]=c.useState(""),[G,D]=c.useState(""),[q,R]=c.useState([]),[k,$]=c.useState(!1),x=!!d,[t,l]=c.useState({description:"",asset_type:"depreciable",quantity:1,loan_agreement:"Default",include_in_audits:!1,last_audited:"",is_serialized:!1,date_received:"",notes:"",manufacturer:"",brand:"",model:"",life_months:60,reference:"",supplier_id:null,supplier_name:"",purchase_date:"",in_service_date:"",warranty_expires:"",vat_inclusive:!1,vat_rate:0,gross_amount:0,total_net_cost:0,unit_cost:0,status:"ACTIVE",depr_method:"straight_line",residual_rate:0});c.useEffect(()=>{const s=a=>{a.key==="Escape"&&u(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[u]),c.useEffect(()=>{(async()=>{if(d){g(!0);try{const a=(await b.get(`/app/api/assets/${d}`)).data||{};l(h=>({...h,...a,asset_type:a.asset_type||"depreciable",total_net_cost:a.total_net_cost??a.gross_amount??0,unit_cost:a.unit_cost??(a.quantity?Number(((a.total_net_cost??a.gross_amount??0)/a.quantity).toFixed(2)):0)})),_(a.class_name||a.class_code||""),T(a.category_name||a.category_code||""),E(a.type_name||a.type_code||""),D(a.supplier_name||"")}finally{g(!1)}}})()},[d]);const w=c.useMemo(()=>{const s=Number(t.quantity||0),a=Number(t.gross_amount||0),h=Number(t.vat_rate||0)/100;let f=Number(t.total_net_cost??0);t.vat_inclusive&&h>0?f=+(a/(1+h)).toFixed(2):t.vat_inclusive||(f=Number(t.total_net_cost??a));const A=s>0?+(f/s).toFixed(2):0;return{net:f,unit:A}},[t.quantity,t.gross_amount,t.vat_inclusive,t.vat_rate,t.total_net_cost]);c.useEffect(()=>{l(s=>({...s,total_net_cost:w.net,unit_cost:w.unit}))},[w.net,w.unit]);async function L(s=!0){v(!0);try{const a={...t};["date_received","purchase_date","in_service_date","warranty_expires","last_audited"].forEach(h=>{a[h]===""&&(a[h]=null)}),x?await b.patch(`/app/api/assets/${d}`,a,{headers:{"X-XSRF-TOKEN":U.get("XSRF-TOKEN")||""},withCredentials:!0}):await b.post("/app/api/assets",a,{headers:{"X-XSRF-TOKEN":U.get("XSRF-TOKEN")||""},withCredentials:!0}),s&&u(!0)}catch(a){alert(a?.response?.data?.message||"Save failed")}finally{v(!1)}}function C(){return e.jsx("div",{className:"pt-4 flex justify-end",children:e.jsx("button",{onClick:()=>L(!1),disabled:p,className:"px-4 py-2 bg-green-700 text-white rounded hover:bg-green-600 disabled:opacity-50",children:"Save This Tab"})})}async function I(){if(x){$(!0);try{const s=await b.post(`/app/api/assets/${d}/depreciation/preview`,{});R(s.data?.rows||[])}catch{R([])}finally{$(!1)}}}c.useEffect(()=>{o==="Depreciation"&&x&&I()},[o,x]);function n({children:s}){return e.jsx("label",{className:"block text-xs font-semibold text-green-800 tracking-wide uppercase mb-1",children:s})}function r({children:s,col:a="col-span-4"}){return e.jsx("div",{className:`${a} min-w-0`,children:s})}const i="w-full border-2 border-green-300 rounded-lg px-3 py-2 text-[15px] focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-500 bg-white",y=i,z=i,F="h-5 w-5 accent-green-600";return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40",onClick:()=>u(!1)}),e.jsx("div",{className:"relative z-50 mx-auto my-6 w-full max-w-7xl",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between p-4 border-b bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:p,onClick:()=>L(!0),className:"px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",children:"Save and Close"}),e.jsx("button",{disabled:p,onClick:()=>L(!1),className:"px-4 py-2 border-2 border-green-300 rounded-lg hover:bg-green-50 disabled:opacity-50",children:"Save"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:x?"Asset Number":"New Asset"}),e.jsx("div",{className:"font-semibold text-lg text-green-800",children:x?t.asset_no||"":"tmp(temporary)"})]}),e.jsx("button",{onClick:()=>u(!1),className:"p-1 rounded hover:bg-green-100",children:e.jsx(M,{className:"h-7 w-7 text-gray-600"})})]}),e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Description"}),e.jsx("input",{className:i,value:t.description,onChange:s=>l(a=>({...a,description:s.target.value})),required:!0})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Asset Type"}),e.jsxs("select",{className:z,value:t.asset_type,onChange:s=>l(a=>({...a,asset_type:s.target.value})),children:[e.jsx("option",{value:"depreciable",children:"Depreciable"}),e.jsx("option",{value:"non_depreciable",children:"Non Depreciable"})]})]}),e.jsxs(r,{col:"col-span-8",children:[e.jsx(n,{children:"Asset Group (Class)"}),e.jsx(S,{placeholder:"Search class…",fetchUrl:"/app/api/assets/classes",selectedLabel:N,onChange:s=>{l(a=>({...a,class_code:s?.value||null,class_name:s?.label||null})),_(s?.label||"")}})]}),e.jsxs(r,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Sub Group (Category)"}),e.jsx(S,{placeholder:"Search category…",fetchUrl:"/app/api/assets/categories",selectedLabel:P,onChange:s=>{l(a=>({...a,category_code:s?.value||null,category_name:s?.label||null})),T(s?.label||"")}})]}),e.jsxs(r,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Comp Group (Type)"}),e.jsx(S,{placeholder:"Search type…",fetchUrl:"/app/api/assets/types",selectedLabel:B,onChange:s=>{l(a=>({...a,type_code:s?.value||null,type_name:s?.label||null})),E(s?.label||"")}})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Quantity"}),e.jsx("input",{type:"number",min:1,step:1,className:i,value:t.quantity,onChange:s=>l(a=>({...a,quantity:Number(s.target.value||1)}))})]})]})}),e.jsx("div",{className:"col-span-12 lg:col-span-4",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Asset Number"}),e.jsx("input",{className:i,value:t.asset_no||"tmp(temporary)",disabled:!0})]}),x&&e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"QR Code"}),e.jsx("div",{className:"border rounded-lg p-3 flex items-center justify-center bg-white",children:e.jsx("img",{src:`/app/api/assets/${d}/qr.svg`,alt:"Asset QR",className:"max-h-40",onError:s=>s.currentTarget.style.display="none"})})]}),e.jsx(r,{col:"col-span-12",children:e.jsxs("div",{className:"rounded-xl border-2 border-green-200 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-green-800 mb-3",children:"Options"}),e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-12",children:[e.jsx(n,{children:"Loan Agreement"}),e.jsxs("select",{className:z,value:t.loan_agreement||"Default",onChange:s=>l(a=>({...a,loan_agreement:s.target.value})),children:[e.jsx("option",{children:"Default"}),e.jsx("option",{children:"Lease"}),e.jsx("option",{children:"Loan"})]})]}),e.jsxs("div",{className:"col-span-6 flex items-center gap-3 mt-2",children:[e.jsx("input",{type:"checkbox",className:F,checked:!!t.include_in_audits,onChange:s=>l(a=>({...a,include_in_audits:s.target.checked}))}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Include in Audits"})]}),e.jsxs("div",{className:"col-span-6",children:[e.jsx(n,{children:"Last Audited"}),e.jsx("input",{type:"date",className:y,value:t.last_audited||"",onChange:s=>l(a=>({...a,last_audited:s.target.value||null}))})]})]})]})})]})})]})}),e.jsx("div",{className:"px-5 sticky top-[64px] z-10 bg-white border-b",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:["General","Finance","Notes","History","Picture","Depreciation"].map(s=>e.jsx("button",{onClick:()=>m(s),className:`px-4 py-2 border-b-2 -mb-px text-sm font-semibold ${o===s?"border-green-700 text-green-700":"border-transparent text-gray-600 hover:text-gray-800"}`,children:s},s))})}),e.jsxs("div",{className:"p-5",children:[j&&e.jsx("div",{className:"p-6 text-center",children:"Loading…"}),!j&&e.jsxs(e.Fragment,{children:[o==="General"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Serialized"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:F,checked:!!t.is_serialized,onChange:s=>l(a=>({...a,is_serialized:s.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Date Received"}),e.jsx("input",{type:"date",className:y,value:t.date_received||"",onChange:s=>l(a=>({...a,date_received:s.target.value||null}))})]}),e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${i} min-h-36`,value:t.notes||"",onChange:s=>l(a=>({...a,notes:s.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Manufacturer"}),e.jsx("input",{className:i,value:t.manufacturer||"",onChange:s=>l(a=>({...a,manufacturer:s.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Brand"}),e.jsx("input",{className:i,value:t.brand||"",onChange:s=>l(a=>({...a,brand:s.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Model"}),e.jsx("input",{className:i,value:t.model||"",onChange:s=>l(a=>({...a,model:s.target.value}))})]})]}),e.jsx(C,{})]}),o==="Finance"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"Life (months)"}),e.jsx("input",{type:"number",min:0,className:i,value:t.life_months,onChange:s=>l(a=>({...a,life_months:Number(s.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-5",children:[e.jsx(n,{children:"Reference (CV/PO/Invoice)"}),e.jsx("input",{className:i,value:t.reference||"",onChange:s=>l(a=>({...a,reference:s.target.value}))})]}),e.jsxs(r,{col:"col-span-5",children:[e.jsx(n,{children:"Supplier"}),e.jsx(S,{placeholder:"Search supplier…",fetchUrl:"/app/api/lookups/vendors",selectedLabel:G,onChange:s=>{l(a=>({...a,supplier_id:s?.id||null,supplier_name:s?.label||null})),D(s?.label||"")}})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Purchased"}),e.jsx("input",{type:"date",className:y,value:t.purchase_date||"",onChange:s=>l(a=>({...a,purchase_date:s.target.value||null}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"In Service"}),e.jsx("input",{type:"date",className:y,value:t.in_service_date||"",onChange:s=>l(a=>({...a,in_service_date:s.target.value||null}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Warranty Expires"}),e.jsx("input",{type:"date",className:y,value:t.warranty_expires||"",onChange:s=>l(a=>({...a,warranty_expires:s.target.value||null}))})]}),e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"VAT Inclusive"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:F,checked:!!t.vat_inclusive,onChange:s=>l(a=>({...a,vat_inclusive:s.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"VAT %"}),e.jsx("input",{type:"number",min:0,max:100,step:.01,className:i,value:t.vat_rate??0,onChange:s=>l(a=>({...a,vat_rate:Number(s.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Total Gross Amount"}),e.jsx("input",{type:"number",min:0,step:.01,className:i,value:t.gross_amount,onChange:s=>l(a=>({...a,gross_amount:Number(s.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Total Net Cost"}),e.jsx("input",{type:"number",min:0,step:.01,className:i,value:t.total_net_cost??0,onChange:s=>l(a=>({...a,total_net_cost:Number(s.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Unit Cost"}),e.jsx("input",{type:"number",className:i,value:t.unit_cost??0,readOnly:!0})]})]}),e.jsx(C,{})]}),o==="Notes"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${i} min-h-60`,value:t.notes||"",onChange:s=>l(a=>({...a,notes:s.target.value}))}),e.jsx(C,{})]}),o==="History"&&e.jsx(e.Fragment,{children:e.jsx(X,{table:"asset_details",id:d||0})}),o==="Picture"&&e.jsxs(e.Fragment,{children:[x?e.jsx(K,{id:d,currentUrl:t.picture_path||void 0,onUploaded:s=>l(a=>({...a,picture_path:s}))}):e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to upload a picture."}),x&&e.jsx(C,{})]}),o==="Depreciation"&&e.jsxs("div",{className:"space-y-3",children:[!x&&e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to compute depreciation."}),x&&e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Period"}),e.jsx("th",{className:"p-2 text-left",children:"Month Sequence"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Year"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Month"}),e.jsx("th",{className:"p-2 text-right",children:"Depreciation Amount"})]})}),e.jsxs("tbody",{children:[k&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center",children:"Loading…"})}),!k&&q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center text-gray-500",children:"No schedule rows"})}),!k&&q.map((s,a)=>{const h=new Date(s.period_start),f=h.getUTCFullYear(),A=h.toLocaleString("en",{month:"short"}),O=a+1;return e.jsxs("tr",{className:a%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsx("td",{className:"p-2",children:O}),e.jsx("td",{className:"p-2",children:f}),e.jsx("td",{className:"p-2",children:A}),e.jsx("td",{className:"p-2 text-right",children:new Intl.NumberFormat(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}).format(s.depreciation)})]},`${s.period}-${a}`)})]})]})})]})]})]})]})]})})]})}function X({table:d,id:u}){const[o,m]=c.useState([]),[j,g]=c.useState(!1);return c.useEffect(()=>{u&&(async()=>{g(!0);try{const p=await b.get("/app/api/audit-logs",{params:{table:d,id:u}});m(p.data||[])}finally{g(!1)}})()},[d,u]),j?e.jsx("div",{children:"Loading…"}):o.length?e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Time Stamp"}),e.jsx("th",{className:"p-2 text-left",children:"Description"}),e.jsx("th",{className:"p-2 text-left",children:"Comment"}),e.jsx("th",{className:"p-2 text-left",children:"User Name"}),e.jsx("th",{className:"p-2 text-left",children:"Computer Name"})]})}),e.jsx("tbody",{children:o.map((p,v)=>e.jsxs("tr",{className:v%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:p.changed_at}),e.jsx("td",{className:"p-2",children:p.action}),e.jsx("td",{className:"p-2",children:p.summary||""}),e.jsx("td",{className:"p-2",children:p.changed_by||""}),e.jsx("td",{className:"p-2",children:p.workstation_id||""})]},v))})]})}):e.jsx("div",{className:"text-sm text-gray-600",children:"No history yet."})}function K({id:d,currentUrl:u,onUploaded:o}){const[m,j]=c.useState(null),[g,p]=c.useState(!1);async function v(){if(m){p(!0);try{const N=new FormData;N.append("file",m);const _=await b.post(`/app/api/assets/${d}/picture`,N,{headers:{"Content-Type":"multipart/form-data"}});o(_.data.picture_path)}finally{p(!1),j(null)}}}return e.jsxs("div",{className:"space-y-3",children:[u&&e.jsx("img",{src:u,alt:"Asset",className:"max-h-64 rounded border shadow"}),e.jsx("input",{type:"file",accept:"image/*",onChange:N=>j(N.target.files?.[0]||null)}),e.jsx("button",{disabled:!m||g,onClick:v,className:"px-4 py-2 bg-green-700 text-white rounded disabled:opacity-50",children:"Upload"})]})}export{W as default};
