import{n as b,j as e,F as H,a as z}from"./index-Dq4xTsPt.js";import{r}from"./handsontable-DB04mlRq.js";import F from"./SearchableCombo-DG8d4j03.js";import Q from"./ComboBox-BAHZn64c.js";import"./react-DJG_os-6.js";function le({id:d,onClose:h}){const[u,g]=r.useState("General"),[j,y]=r.useState(!1),[p,f]=r.useState(!1),[v,w]=r.useState(""),[O,A]=r.useState(""),[B,C]=r.useState(""),[G,R]=r.useState(""),[$,q]=r.useState([]),[D,P]=r.useState(!1),[U,S]=r.useState(""),I=r.useRef(null),m=!!d,[t,l]=r.useState({description:"",asset_type:"depreciable",quantity:1,loan_agreement:"Default",include_in_audits:!1,last_audited:"",is_serialized:!1,date_received:"",notes:"",manufacturer:"",brand:"",model:"",life_months:60,reference:"",supplier_id:null,supplier_name:"",purchase_date:"",in_service_date:"",warranty_expires:"",vat_inclusive:!1,vat_rate:0,gross_amount:0,total_net_cost:0,unit_cost:0,status:"ACTIVE",depr_method:"straight_line",residual_rate:0}),[M,X]=r.useState([]);r.useEffect(()=>{(async()=>{try{const s=await b.get("/lookups/depreciation-types"),i=(Array.isArray(s.data)?s.data:[]).map(x=>({id:x.value??x.id,label:x.label}));if(X(i),!U&&t.asset_type){const x=i.find(_=>String(_.id)===String(t.asset_type));x&&S(x.label)}}catch{}})()},[]),r.useEffect(()=>{const s=a=>{a.key==="Escape"&&h(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[h]),r.useEffect(()=>{(async()=>{if(d){y(!0);try{const a=(await b.get(`/app/api/assets/${d}`)).data||{};l(i=>({...i,...a,asset_type:a.asset_type||"depreciable",total_net_cost:a.total_net_cost??a.gross_amount??0,unit_cost:a.unit_cost??(a.quantity?Number(((a.total_net_cost??a.gross_amount??0)/a.quantity).toFixed(2)):0)})),S(a.asset_type==="non_depreciable"?"Non-Depreciable":"Depreciable"),w(a.class_name||a.class_code||""),A(a.category_name||a.category_code||""),C(a.type_name||a.type_code||""),R(a.supplier_name||"")}finally{y(!1)}}})()},[d]);const k=r.useMemo(()=>{const s=Number(t.quantity||0),a=Number(t.gross_amount||0),i=Number(t.vat_rate||0)/100;let x=Number(t.total_net_cost??0);t.vat_inclusive&&i>0?x=+(a/(1+i)).toFixed(2):t.vat_inclusive||(x=Number(t.total_net_cost??a));const _=s>0?+(x/s).toFixed(2):0;return{net:x,unit:_}},[t.quantity,t.gross_amount,t.vat_inclusive,t.vat_rate,t.total_net_cost]);r.useEffect(()=>{l(s=>({...s,total_net_cost:k.net,unit_cost:k.unit}))},[k.net,k.unit]);async function E(s=!0){f(!0);try{const a={...t};["date_received","purchase_date","in_service_date","warranty_expires","last_audited"].forEach(i=>{a[i]===""&&(a[i]=null)}),m?await b.patch(`/app/api/assets/${d}`,a,{headers:{"X-XSRF-TOKEN":z.get("XSRF-TOKEN")||""},withCredentials:!0}):await b.post("/app/api/assets",a,{headers:{"X-XSRF-TOKEN":z.get("XSRF-TOKEN")||""},withCredentials:!0}),s&&h(!0)}catch(a){alert(a?.response?.data?.message||"Save failed")}finally{f(!1)}}function L(){return e.jsx("div",{className:"pt-4 flex justify-end",children:e.jsx("button",{onClick:()=>E(!1),disabled:p,className:"px-4 py-2 bg-green-700 text-white rounded hover:bg-green-600 disabled:opacity-50",children:"Save This Tab"})})}async function K(){if(m){P(!0);try{const s=await b.post(`/app/api/assets/${d}/depreciation/preview`,{});q(s.data?.rows||[])}catch{q([])}finally{P(!1)}}}r.useEffect(()=>{u==="Depreciation"&&m&&K()},[u,m]);function n({children:s}){return e.jsx("label",{className:"block text-xs font-semibold text-green-800 tracking-wide uppercase mb-1",children:s})}function c({children:s,col:a="col-span-4"}){return e.jsx("div",{className:`${a} min-w-0`,children:s})}const o="w-full border-2 border-green-300 rounded-lg px-3 py-2 text-[15px] focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-500 bg-white",N=o,V=o,T="h-5 w-5 accent-green-600";return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40",onClick:()=>h(!1)}),e.jsx("div",{className:"relative z-50 mx-auto my-6 w-full max-w-7xl",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between p-4 border-b bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:p,onClick:()=>E(!0),className:"px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",children:"Save and Close"}),e.jsx("button",{disabled:p,onClick:()=>E(!1),className:"px-4 py-2 border-2 border-green-300 rounded-lg hover:bg-green-50 disabled:opacity-50",children:"Save"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:m?"Asset Number":"New Asset"}),e.jsx("div",{className:"font-semibold text-lg text-green-800",children:m?t.asset_no||"":"tmp(temporary)"})]}),e.jsx("button",{onClick:()=>h(!1),className:"p-1 rounded hover:bg-green-100",children:e.jsx(H,{className:"h-7 w-7 text-gray-600"})})]}),e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(c,{col:"col-span-12",children:[e.jsx(n,{children:"Description"}),e.jsx("input",{ref:I,className:o,value:t.description,onChange:s=>{const a=s.target.value;l(i=>({...i,description:a})),requestAnimationFrame(()=>I.current?.focus())},required:!0})]}),e.jsx(c,{col:"col-span-4",children:e.jsx(Q,{label:"Asset Depreciation Type",placeholder:"Pick depreciation type…",options:M,valueLabel:U,onInputChange:S,onSelect:s=>{S(s.label),l(a=>({...a,asset_type:s.id}))},required:!0})}),e.jsxs(c,{col:"col-span-8",children:[e.jsx(n,{children:"Asset Group (Class)"}),e.jsx(F,{placeholder:"Search class…",fetchUrl:"assets/lookups/classes",selectedLabel:v,onChange:s=>{l(a=>({...a,class_code:s?.value||null,class_name:s?.label||null,category_code:null,category_name:null,type_code:null,type_name:null})),w(s?.label||""),A(""),C("")}})]}),e.jsxs(c,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Sub Group (Category)"}),e.jsx(F,{placeholder:t.class_code?"Search category…":"Pick a class first…",fetchUrl:`assets/lookups/categories?class_code=${encodeURIComponent(t.class_code||"")}`,selectedLabel:O,onChange:s=>{l(a=>({...a,category_code:s?.value||null,category_name:s?.label||null,type_code:null,type_name:null})),A(s?.label||""),C("")}},`cat-${t.class_code||"none"}`)]}),e.jsxs(c,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Comp Group (Type)"}),e.jsx(F,{placeholder:t.category_code?"Search type…":"Pick a category first…",fetchUrl:`assets/types-by-cat?cat_code=${encodeURIComponent(t.category_code||"")}`,selectedLabel:B,onChange:s=>{l(a=>({...a,type_code:s?.value||null,type_name:s?.label||null})),C(s?.label||"")}},`type-${t.category_code||"none"}`)]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Quantity"}),e.jsx("input",{type:"number",min:1,step:1,className:o,value:t.quantity,onChange:s=>l(a=>({...a,quantity:Number(s.target.value||1)}))})]})]})}),e.jsx("div",{className:"col-span-12 lg:col-span-4",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(c,{col:"col-span-12",children:[e.jsx(n,{children:"Asset Number"}),e.jsx("input",{className:o,value:t.asset_no||"tmp(temporary)",disabled:!0})]}),m&&e.jsxs(c,{col:"col-span-12",children:[e.jsx(n,{children:"QR Code"}),e.jsx("div",{className:"border rounded-lg p-3 flex items-center justify-center bg-white",children:e.jsx("img",{src:`/app/api/assets/${d}/qr.svg`,alt:"Asset QR",className:"max-h-40",onError:s=>s.currentTarget.style.display="none"})})]}),e.jsx(c,{col:"col-span-12",children:e.jsxs("div",{className:"rounded-xl border-2 border-green-200 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-green-800 mb-3",children:"Options"}),e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-12",children:[e.jsx(n,{children:"Loan Agreement"}),e.jsxs("select",{className:V,value:t.loan_agreement||"Default",onChange:s=>l(a=>({...a,loan_agreement:s.target.value})),children:[e.jsx("option",{children:"Default"}),e.jsx("option",{children:"Lease"}),e.jsx("option",{children:"Loan"})]})]}),e.jsxs("div",{className:"col-span-6 flex items-center gap-3 mt-2",children:[e.jsx("input",{type:"checkbox",className:T,checked:!!t.include_in_audits,onChange:s=>l(a=>({...a,include_in_audits:s.target.checked}))}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Include in Audits"})]}),e.jsxs("div",{className:"col-span-6",children:[e.jsx(n,{children:"Last Audited"}),e.jsx("input",{type:"date",className:N,value:t.last_audited||"",onChange:s=>l(a=>({...a,last_audited:s.target.value||null}))})]})]})]})})]})})]})}),e.jsx("div",{className:"px-5 sticky top-[64px] z-10 bg-white border-b",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:["General","Finance","Notes","History","Picture","Depreciation"].map(s=>e.jsx("button",{onClick:()=>g(s),className:`px-4 py-2 border-b-2 -mb-px text-sm font-semibold ${u===s?"border-green-700 text-green-700":"border-transparent text-gray-600 hover:text-gray-800"}`,children:s},s))})}),e.jsxs("div",{className:"p-5",children:[j&&e.jsx("div",{className:"p-6 text-center",children:"Loading…"}),!j&&e.jsxs(e.Fragment,{children:[u==="General"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Serialized"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:T,checked:!!t.is_serialized,onChange:s=>l(a=>({...a,is_serialized:s.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(c,{col:"col-span-4",children:[e.jsx(n,{children:"Date Received"}),e.jsx("input",{type:"date",className:N,value:t.date_received||"",onChange:s=>l(a=>({...a,date_received:s.target.value||null}))})]}),e.jsxs(c,{col:"col-span-12",children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${o} min-h-36`,value:t.notes||"",onChange:s=>l(a=>({...a,notes:s.target.value}))})]}),e.jsxs(c,{col:"col-span-4",children:[e.jsx(n,{children:"Manufacturer"}),e.jsx("input",{className:o,value:t.manufacturer||"",onChange:s=>l(a=>({...a,manufacturer:s.target.value}))})]}),e.jsxs(c,{col:"col-span-4",children:[e.jsx(n,{children:"Brand"}),e.jsx("input",{className:o,value:t.brand||"",onChange:s=>l(a=>({...a,brand:s.target.value}))})]}),e.jsxs(c,{col:"col-span-4",children:[e.jsx(n,{children:"Model"}),e.jsx("input",{className:o,value:t.model||"",onChange:s=>l(a=>({...a,model:s.target.value}))})]})]}),e.jsx(L,{})]}),u==="Finance"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(c,{col:"col-span-2",children:[e.jsx(n,{children:"Life (months)"}),e.jsx("input",{type:"number",min:0,className:o,value:t.life_months,onChange:s=>l(a=>({...a,life_months:Number(s.target.value||0)}))})]}),e.jsxs(c,{col:"col-span-5",children:[e.jsx(n,{children:"Reference (CV/PO/Invoice)"}),e.jsx("input",{className:o,value:t.reference||"",onChange:s=>l(a=>({...a,reference:s.target.value}))})]}),e.jsxs(c,{col:"col-span-5",children:[e.jsx(n,{children:"Supplier"}),e.jsx(F,{placeholder:"Search supplier…",fetchUrl:"/app/api/lookups/vendors",selectedLabel:G,onChange:s=>{const a=s?.id===void 0||s?.id===null?null:Number(s.id);l(i=>({...i,supplier_id:a,supplier_name:s?.label??null})),R(s?.label||"")}})]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Purchased"}),e.jsx("input",{type:"date",className:N,value:t.purchase_date||"",onChange:s=>l(a=>({...a,purchase_date:s.target.value||null}))})]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"In Service"}),e.jsx("input",{type:"date",className:N,value:t.in_service_date||"",onChange:s=>l(a=>({...a,in_service_date:s.target.value||null}))})]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Warranty Expires"}),e.jsx("input",{type:"date",className:N,value:t.warranty_expires||"",onChange:s=>l(a=>({...a,warranty_expires:s.target.value||null}))})]}),e.jsxs(c,{col:"col-span-2",children:[e.jsx(n,{children:"VAT Inclusive"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:T,checked:!!t.vat_inclusive,onChange:s=>l(a=>({...a,vat_inclusive:s.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(c,{col:"col-span-2",children:[e.jsx(n,{children:"VAT %"}),e.jsx("input",{type:"number",min:0,max:100,step:.01,className:o,value:t.vat_rate??0,onChange:s=>l(a=>({...a,vat_rate:Number(s.target.value||0)}))})]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Total Gross Amount"}),e.jsx("input",{type:"number",min:0,step:.01,className:o,value:t.gross_amount,onChange:s=>l(a=>({...a,gross_amount:Number(s.target.value||0)}))})]}),e.jsxs(c,{col:"col-span-4",children:[e.jsx(n,{children:"Total Net Cost"}),e.jsx("input",{type:"number",min:0,step:.01,className:o,value:t.total_net_cost??0,onChange:s=>l(a=>({...a,total_net_cost:Number(s.target.value||0)}))})]}),e.jsxs(c,{col:"col-span-3",children:[e.jsx(n,{children:"Unit Cost"}),e.jsx("input",{type:"number",className:o,value:t.unit_cost??0,readOnly:!0})]})]}),e.jsx(L,{})]}),u==="Notes"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${o} min-h-60`,value:t.notes||"",onChange:s=>l(a=>({...a,notes:s.target.value}))}),e.jsx(L,{})]}),u==="History"&&e.jsx(e.Fragment,{children:e.jsx(W,{table:"asset_details",id:d||0})}),u==="Picture"&&e.jsxs(e.Fragment,{children:[m?e.jsx(J,{id:d,currentUrl:t.picture_path||void 0,onUploaded:s=>l(a=>({...a,picture_path:s}))}):e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to upload a picture."}),m&&e.jsx(L,{})]}),u==="Depreciation"&&e.jsxs("div",{className:"space-y-3",children:[!m&&e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to compute depreciation."}),m&&e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Period"}),e.jsx("th",{className:"p-2 text-left",children:"Month Sequence"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Year"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Month"}),e.jsx("th",{className:"p-2 text-right",children:"Depreciation Amount"})]})}),e.jsxs("tbody",{children:[D&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center",children:"Loading…"})}),!D&&$.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center text-gray-500",children:"No schedule rows"})}),!D&&$.map((s,a)=>{const i=new Date(s.period_start),x=i.getUTCFullYear(),_=i.toLocaleString("en",{month:"short"}),Y=a+1;return e.jsxs("tr",{className:a%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsx("td",{className:"p-2",children:Y}),e.jsx("td",{className:"p-2",children:x}),e.jsx("td",{className:"p-2",children:_}),e.jsx("td",{className:"p-2 text-right",children:new Intl.NumberFormat(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}).format(s.depreciation)})]},`${s.period}-${a}`)})]})]})})]})]})]})]})]})})]})}function W({table:d,id:h}){const[u,g]=r.useState([]),[j,y]=r.useState(!1);return r.useEffect(()=>{h&&(async()=>{y(!0);try{const p=await b.get("/app/api/audit-logs",{params:{table:d,id:h}});g(p.data||[])}finally{y(!1)}})()},[d,h]),j?e.jsx("div",{children:"Loading…"}):u.length?e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Time Stamp"}),e.jsx("th",{className:"p-2 text-left",children:"Description"}),e.jsx("th",{className:"p-2 text-left",children:"Comment"}),e.jsx("th",{className:"p-2 text-left",children:"User Name"}),e.jsx("th",{className:"p-2 text-left",children:"Computer Name"})]})}),e.jsx("tbody",{children:u.map((p,f)=>e.jsxs("tr",{className:f%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:p.changed_at}),e.jsx("td",{className:"p-2",children:p.action}),e.jsx("td",{className:"p-2",children:p.summary||""}),e.jsx("td",{className:"p-2",children:p.changed_by||""}),e.jsx("td",{className:"p-2",children:p.workstation_id||""})]},f))})]})}):e.jsx("div",{className:"text-sm text-gray-600",children:"No history yet."})}function J({id:d,currentUrl:h,onUploaded:u}){const[g,j]=r.useState(null),[y,p]=r.useState(!1);async function f(){if(g){p(!0);try{const v=new FormData;v.append("file",g);const w=await b.post(`/app/api/assets/${d}/picture`,v,{headers:{"Content-Type":"multipart/form-data"}});u(w.data.picture_path)}finally{p(!1),j(null)}}}return e.jsxs("div",{className:"space-y-3",children:[h&&e.jsx("img",{src:h,alt:"Asset",className:"max-h-64 rounded border shadow"}),e.jsx("input",{type:"file",accept:"image/*",onChange:v=>j(v.target.files?.[0]||null)}),e.jsx("button",{disabled:!g||y,onClick:f,className:"px-4 py-2 bg-green-700 text-white rounded disabled:opacity-50",children:"Upload"})]})}export{le as default};
