import{n as b,j as e,F as O,a as U}from"./index-CjQQQ6If.js";import{r as c}from"./handsontable-B9UYrM3w.js";import w from"./SearchableCombo-CLnreiYR.js";import"./react-DJG_os-6.js";function Q({id:o,onClose:u}){const[d,m]=c.useState("General"),[g,j]=c.useState(!1),[p,N]=c.useState(!1),[v,_]=c.useState(""),[P,A]=c.useState(""),[B,F]=c.useState(""),[G,D]=c.useState(""),[T,E]=c.useState([]),[S,q]=c.useState(!1),x=!!o,[t,l]=c.useState({description:"",asset_type:"depreciable",quantity:1,loan_agreement:"Default",include_in_audits:!1,last_audited:"",is_serialized:!1,date_received:"",notes:"",manufacturer:"",brand:"",model:"",life_months:60,reference:"",supplier_id:null,supplier_name:"",purchase_date:"",in_service_date:"",warranty_expires:"",vat_inclusive:!1,vat_rate:0,gross_amount:0,total_net_cost:0,unit_cost:0,status:"ACTIVE",depr_method:"straight_line",residual_rate:0});c.useEffect(()=>{(async()=>{if(o){j(!0);try{const s=(await b.get(`/app/api/assets/${o}`)).data||{};l(h=>({...h,...s,asset_type:s.asset_type||"depreciable",total_net_cost:s.total_net_cost??s.gross_amount??0,unit_cost:s.unit_cost??(s.quantity?Number(((s.total_net_cost??s.gross_amount??0)/s.quantity).toFixed(2)):0)})),_(s.class_name||s.class_code||""),A(s.category_name||s.category_code||""),F(s.type_name||s.type_code||""),D(s.supplier_name||"")}finally{j(!1)}}})()},[o]);const C=c.useMemo(()=>{const a=Number(t.quantity||0),s=Number(t.gross_amount||0),h=Number(t.vat_rate||0)/100;let f=Number(t.total_net_cost??0);t.vat_inclusive&&h>0?f=+(s/(1+h)).toFixed(2):t.vat_inclusive||(f=Number(t.total_net_cost??s));const k=a>0?+(f/a).toFixed(2):0;return{net:f,unit:k}},[t.quantity,t.gross_amount,t.vat_inclusive,t.vat_rate,t.total_net_cost]);c.useEffect(()=>{l(a=>({...a,total_net_cost:C.net,unit_cost:C.unit}))},[C.net,C.unit]);async function R(a=!0){N(!0);try{const s={...t};["date_received","purchase_date","in_service_date","warranty_expires","last_audited"].forEach(h=>{s[h]===""&&(s[h]=null)}),x?await b.patch(`/app/api/assets/${o}`,s,{headers:{"X-XSRF-TOKEN":U.get("XSRF-TOKEN")||""},withCredentials:!0}):await b.post("/app/api/assets",s,{headers:{"X-XSRF-TOKEN":U.get("XSRF-TOKEN")||""},withCredentials:!0}),a&&u(!0)}catch(s){alert(s?.response?.data?.message||"Save failed")}finally{N(!1)}}async function I(){if(x){q(!0);try{const s=(await b.post(`/app/api/assets/${o}/depreciation/preview`,{})).data?.rows||[];E(s)}catch{E([])}finally{q(!1)}}}c.useEffect(()=>{d==="Depreciation"&&x&&I()},[d,x]);function n({children:a}){return e.jsx("label",{className:"block text-xs font-semibold text-green-800 tracking-wide uppercase mb-1",children:a})}function r({children:a,col:s="col-span-4"}){return e.jsx("div",{className:`${s} min-w-0`,children:a})}const i="w-full border-2 border-green-300 rounded-lg px-3 py-2 text-[15px] focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-500 bg-white",y=i,$=i,L="h-5 w-5 accent-green-600";return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-start justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>u(!1)}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl w-full max-w-7xl mx-4 my-6 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:p,onClick:()=>R(!0),className:"px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",children:"Save and Close"}),e.jsx("button",{disabled:p,onClick:()=>R(!1),className:"px-4 py-2 border-2 border-green-300 rounded-lg hover:bg-green-50 disabled:opacity-50",children:"Save"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500",children:x?"Asset Number":"New Asset"}),e.jsx("div",{className:"font-semibold text-lg text-green-800",children:x?t.asset_no||"":"tmp(temporary)"})]}),e.jsx("button",{onClick:()=>u(!1),className:"p-1 rounded hover:bg-green-100",children:e.jsx(O,{className:"h-7 w-7 text-gray-600"})})]}),e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Description"}),e.jsx("input",{className:i,value:t.description,onChange:a=>l(s=>({...s,description:a.target.value})),required:!0})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Asset Type"}),e.jsxs("select",{className:$,value:t.asset_type,onChange:a=>l(s=>({...s,asset_type:a.target.value})),children:[e.jsx("option",{value:"depreciable",children:"Depreciable"}),e.jsx("option",{value:"non_depreciable",children:"Non Depreciable"})]})]}),e.jsxs(r,{col:"col-span-8",children:[e.jsx(n,{children:"Asset Group (Class)"}),e.jsx(w,{placeholder:"Search class…",fetchUrl:"/app/api/assets/classes",selectedLabel:v,onChange:a=>{l(s=>({...s,class_code:a?.value||null,class_name:a?.label||null})),_(a?.label||"")}})]}),e.jsxs(r,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Sub Group (Category)"}),e.jsx(w,{placeholder:"Search category…",fetchUrl:"/app/api/assets/categories",selectedLabel:P,onChange:a=>{l(s=>({...s,category_code:a?.value||null,category_name:a?.label||null})),A(a?.label||"")}})]}),e.jsxs(r,{col:"col-span-6",children:[e.jsx(n,{children:"Asset Comp Group (Type)"}),e.jsx(w,{placeholder:"Search type…",fetchUrl:"/app/api/assets/types",selectedLabel:B,onChange:a=>{l(s=>({...s,type_code:a?.value||null,type_name:a?.label||null})),F(a?.label||"")}})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Quantity"}),e.jsx("input",{type:"number",min:1,step:1,className:i,value:t.quantity,onChange:a=>l(s=>({...s,quantity:Number(a.target.value||1)}))})]})]})}),e.jsx("div",{className:"col-span-12 lg:col-span-4",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Asset Number"}),e.jsx("input",{className:i,value:t.asset_no||"tmp(temporary)",disabled:!0})]}),x&&e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"QR Code"}),e.jsx("div",{className:"border rounded-lg p-3 flex items-center justify-center bg-white",children:e.jsx("img",{src:`/app/api/assets/${o}/qr.svg`,alt:"Asset QR",className:"max-h-40",onError:a=>a.currentTarget.style.display="none"})})]}),e.jsx(r,{col:"col-span-12",children:e.jsxs("div",{className:"rounded-xl border-2 border-green-200 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-green-800 mb-3",children:"Options"}),e.jsxs("div",{className:"grid grid-cols-12 gap-3",children:[e.jsxs("div",{className:"col-span-12",children:[e.jsx(n,{children:"Loan Agreement"}),e.jsxs("select",{className:$,value:t.loan_agreement||"Default",onChange:a=>l(s=>({...s,loan_agreement:a.target.value})),children:[e.jsx("option",{children:"Default"}),e.jsx("option",{children:"Lease"}),e.jsx("option",{children:"Loan"})]})]}),e.jsxs("div",{className:"col-span-6 flex items-center gap-3 mt-2",children:[e.jsx("input",{type:"checkbox",className:L,checked:!!t.include_in_audits,onChange:a=>l(s=>({...s,include_in_audits:a.target.checked}))}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Include in Audits"})]}),e.jsxs("div",{className:"col-span-6",children:[e.jsx(n,{children:"Last Audited"}),e.jsx("input",{type:"date",className:y,value:t.last_audited||"",onChange:a=>l(s=>({...s,last_audited:a.target.value||null}))})]})]})]})})]})})]})}),e.jsx("div",{className:"px-5",children:e.jsx("div",{className:"flex flex-wrap gap-2 border-b",children:["General","Finance","Notes","History","Picture","Depreciation"].map(a=>e.jsx("button",{onClick:()=>m(a),className:`px-4 py-2 border-b-2 -mb-px text-sm font-semibold ${d===a?"border-green-700 text-green-700":"border-transparent text-gray-600 hover:text-gray-800"}`,children:a},a))})}),e.jsxs("div",{className:"p-5",children:[g&&e.jsx("div",{className:"p-6 text-center",children:"Loading…"}),!g&&e.jsxs(e.Fragment,{children:[d==="General"&&e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Serialized"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:L,checked:!!t.is_serialized,onChange:a=>l(s=>({...s,is_serialized:a.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Date Received"}),e.jsx("input",{type:"date",className:y,value:t.date_received||"",onChange:a=>l(s=>({...s,date_received:a.target.value||null}))})]}),e.jsxs(r,{col:"col-span-12",children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${i} min-h-36`,value:t.notes||"",onChange:a=>l(s=>({...s,notes:a.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Manufacturer"}),e.jsx("input",{className:i,value:t.manufacturer||"",onChange:a=>l(s=>({...s,manufacturer:a.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Brand"}),e.jsx("input",{className:i,value:t.brand||"",onChange:a=>l(s=>({...s,brand:a.target.value}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Model"}),e.jsx("input",{className:i,value:t.model||"",onChange:a=>l(s=>({...s,model:a.target.value}))})]})]}),d==="Finance"&&e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"Life (months)"}),e.jsx("input",{type:"number",min:0,className:i,value:t.life_months,onChange:a=>l(s=>({...s,life_months:Number(a.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-5",children:[e.jsx(n,{children:"Reference (CV/PO/Invoice)"}),e.jsx("input",{className:i,value:t.reference||"",onChange:a=>l(s=>({...s,reference:a.target.value}))})]}),e.jsxs(r,{col:"col-span-5",children:[e.jsx(n,{children:"Supplier"}),e.jsx(w,{placeholder:"Search supplier…",fetchUrl:"/app/api/lookups/vendors",selectedLabel:G,onChange:a=>{l(s=>({...s,supplier_id:a?.id||null,supplier_name:a?.label||null})),D(a?.label||"")}})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Purchased"}),e.jsx("input",{type:"date",className:y,value:t.purchase_date||"",onChange:a=>l(s=>({...s,purchase_date:a.target.value||null}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"In Service"}),e.jsx("input",{type:"date",className:y,value:t.in_service_date||"",onChange:a=>l(s=>({...s,in_service_date:a.target.value||null}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Warranty Expires"}),e.jsx("input",{type:"date",className:y,value:t.warranty_expires||"",onChange:a=>l(s=>({...s,warranty_expires:a.target.value||null}))})]}),e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"VAT Inclusive"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",className:L,checked:!!t.vat_inclusive,onChange:a=>l(s=>({...s,vat_inclusive:a.target.checked}))}),e.jsx("span",{className:"text-sm text-gray-700",children:"Yes"})]})]}),e.jsxs(r,{col:"col-span-2",children:[e.jsx(n,{children:"VAT %"}),e.jsx("input",{type:"number",min:0,max:100,step:.01,className:i,value:t.vat_rate??0,onChange:a=>l(s=>({...s,vat_rate:Number(a.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Total Gross Amount"}),e.jsx("input",{type:"number",min:0,step:.01,className:i,value:t.gross_amount,onChange:a=>l(s=>({...s,gross_amount:Number(a.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-4",children:[e.jsx(n,{children:"Total Net Cost"}),e.jsx("input",{type:"number",min:0,step:.01,className:i,value:t.total_net_cost??0,onChange:a=>l(s=>({...s,total_net_cost:Number(a.target.value||0)}))})]}),e.jsxs(r,{col:"col-span-3",children:[e.jsx(n,{children:"Unit Cost"}),e.jsx("input",{type:"number",className:i,value:t.unit_cost??0,readOnly:!0})]})]}),d==="Notes"&&e.jsxs("div",{children:[e.jsx(n,{children:"Notes"}),e.jsx("textarea",{className:`${i} min-h-60`,value:t.notes||"",onChange:a=>l(s=>({...s,notes:a.target.value}))})]}),d==="History"&&e.jsx(X,{table:"asset_details",id:o||0}),d==="Picture"&&(x?e.jsx(z,{id:o,currentUrl:t.picture_path||void 0,onUploaded:a=>l(s=>({...s,picture_path:a}))}):e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to upload a picture."})),d==="Depreciation"&&e.jsxs("div",{className:"space-y-3",children:[!x&&e.jsx("div",{className:"text-sm text-gray-600",children:"Save the asset first to compute depreciation."}),x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm font-semibold text-green-800",children:"By Month:"}),e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Period"}),e.jsx("th",{className:"p-2 text-left",children:"Month Sequence"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Year"}),e.jsx("th",{className:"p-2 text-left",children:"Actual Month"}),e.jsx("th",{className:"p-2 text-right",children:"Depreciation Amount"})]})}),e.jsxs("tbody",{children:[S&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center",children:"Loading…"})}),!S&&T.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-center text-gray-500",children:"No schedule rows"})}),!S&&T.map((a,s)=>{const h=new Date(a.period_start),f=h.getUTCFullYear(),k=h.toLocaleString("en",{month:"short"}),M=s+1;return e.jsxs("tr",{className:s%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:a.period}),e.jsx("td",{className:"p-2",children:M}),e.jsx("td",{className:"p-2",children:f}),e.jsx("td",{className:"p-2",children:k}),e.jsx("td",{className:"p-2 text-right",children:new Intl.NumberFormat(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}).format(a.depreciation)})]},`${a.period}-${s}`)})]})]})})]})]})]})]})]})]})}function X({table:o,id:u}){const[d,m]=c.useState([]),[g,j]=c.useState(!1);return c.useEffect(()=>{u&&(async()=>{j(!0);try{const p=await b.get("/app/api/audit-logs",{params:{table:o,id:u}});m(p.data||[])}finally{j(!1)}})()},[o,u]),g?e.jsx("div",{children:"Loading…"}):d.length?e.jsx("div",{className:"border rounded overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-green-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Time Stamp"}),e.jsx("th",{className:"p-2 text-left",children:"Description"}),e.jsx("th",{className:"p-2 text-left",children:"Comment"}),e.jsx("th",{className:"p-2 text-left",children:"User Name"}),e.jsx("th",{className:"p-2 text-left",children:"Computer Name"})]})}),e.jsx("tbody",{children:d.map((p,N)=>e.jsxs("tr",{className:N%2?"bg-gray-50":"",children:[e.jsx("td",{className:"p-2",children:p.changed_at}),e.jsx("td",{className:"p-2",children:p.action}),e.jsx("td",{className:"p-2",children:p.summary||""}),e.jsx("td",{className:"p-2",children:p.changed_by||""}),e.jsx("td",{className:"p-2",children:p.workstation_id||""})]},N))})]})}):e.jsx("div",{className:"text-sm text-gray-600",children:"No history yet."})}function z({id:o,currentUrl:u,onUploaded:d}){const[m,g]=c.useState(null),[j,p]=c.useState(!1);async function N(){if(m){p(!0);try{const v=new FormData;v.append("file",m);const _=await b.post(`/app/api/assets/${o}/picture`,v,{headers:{"Content-Type":"multipart/form-data"}});d(_.data.picture_path)}finally{p(!1),g(null)}}}return e.jsxs("div",{className:"space-y-3",children:[u&&e.jsx("img",{src:u,alt:"Asset",className:"max-h-64 rounded border shadow"}),e.jsx("input",{type:"file",accept:"image/*",onChange:v=>g(v.target.files?.[0]||null)}),e.jsx("button",{disabled:!m||j,onClick:N,className:"px-4 py-2 bg-green-700 text-white rounded disabled:opacity-50",children:"Upload"})]})}export{Q as default};
